<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>åœ°å›¾</title>
  <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; overflow: hidden; }
    
    .dashboard-container { 
      display: flex; 
      height: 100%; 
      position: relative;
    }
    
    #container { 
      flex: 1; 
      height: 100%;
      transition: all 0.3s ease;
    }
    
    .right-panel {
      width: 400px;
      background: #f5f5f5;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      box-shadow: -2px 0 5px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    /* æ”¶èµ·çŠ¶æ€ */
    .right-panel.collapsed {
      width: 0;
      padding: 0;
      min-width: 0;
    }
    
    .right-panel.collapsed .panel-content {
      display: none;
    }
    
    .chart-container {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      height: 300px;
      overflow: hidden;
    }
    
    canvas#transportChart {
      width: 100% !important;
      height: 100% !important;
      display: block;
    }
    
    .params-container {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow-y: auto;
      flex: 1;
    }
    
    .param-table { 
      width: 100%; 
      border-collapse: collapse; 
    }
    
    .param-table td {
      padding: 6px; 
      border-bottom: 1px solid #eee;
    }
    
    .param-table td:first-child { 
      font-weight: bold; 
      color: #666; 
    }
    
    .param-table td:last-child { 
      text-align: right; 
      color: #2c3e50; 
    }
    
    .vehicle-list { 
      cursor: pointer; 
      transition: background 0.2s; 
    }
    
    .vehicle-list:hover { 
      background-color: #eef; 
    }
    
    #toggle-chart-type {
      padding: 6px 12px;
      font-size: 13px;
      border: none;
      background-color: #3498db;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    
    #vehicle-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      padding: 20px;
      min-width: 300px;
      max-width: 400px;
    }
    
    #vehicle-list-wrapper {
      height: 200px;
      overflow-y: auto;
      margin-bottom: 15px;
    }

    /* æŠ˜å æŒ‰é’® */
    .collapse-btn {
      position: absolute;
      right: 400px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 60px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 8px 0 0 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      transition: all 0.3s ease;
      z-index: 100;
      box-shadow: -2px 0 5px rgba(0,0,0,0.2);
    }
    
    .collapse-btn:hover {
      background: #2980b9;
      width: 25px;
    }
    
    /* æ”¶èµ·çŠ¶æ€ä¸‹çš„æŒ‰é’®ä½ç½® */
    .right-panel.collapsed ~ .collapse-btn {
      right: 0;
      border-radius: 0 8px 8px 0;
    }
    
    /* é¢æ¿å†…éƒ¨æŠ˜å åŠŸèƒ½ */
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      cursor: pointer;
      user-select: none;
      padding: 5px 0;
    }
    
    .panel-header h3 {
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    
    .collapse-icon {
      transition: transform 0.3s ease;
      font-size: 12px;
      color: #666;
      width: 12px;
      text-align: center;
    }
    
    .panel-content {
      transition: all 0.3s ease;
    }
    
    .panel-content.collapsed {
      display: none;
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    /* åº•éƒ¨æŒ‰é’®å®¹å™¨ */
    .bottom-buttons {
      position: fixed;
      left: 20px;
      bottom: 20px;
      z-index: 999;
      display: flex;
      gap: 10px;
    }

    .bottom-btn {
      padding: 10px 16px;
      color: white;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: background 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .comparison-btn {
      background-color: #27ae60;
    }

    .comparison-btn:hover {
      background-color: #219653;
    }

    .config-btn {
      background-color: #e67e22;
    }

    .config-btn:hover {
      background-color: #d35400;
    }
  </style>
</head>
<body>
<div class="dashboard-container">
  <!-- åº•éƒ¨æŒ‰é’®å®¹å™¨ -->
  <div class="bottom-buttons">
    <button id="open-comparison" class="bottom-btn comparison-btn">
      ğŸ“Š æ‰“å¼€å¯¹æ¯”å›¾
    </button>
    <!-- <button id="open-config" class="bottom-btn config-btn">
      âš™ï¸ ç³»ç»Ÿé…ç½®
    </button> -->
  </div>

  <div id="container"></div>
  
  <div class="right-panel" id="right-panel">
    <div class="chart-container">
      <div class="chart-header">
        <h3>æ€»ä»£ä»·å˜åŒ–</h3>
        <button id="toggle-chart-type">åˆ‡æ¢ä¸ºæŠ˜çº¿å›¾</button>
      </div>
      <canvas id="transportChart"></canvas>
    </div>
    
    <div class="params-container">
      <div class="panel-header" id="vehicle-list-header">
        <h3>
          <span class="collapse-icon">â–¼</span>
          è½¦è¾†åˆ—è¡¨
        </h3>
      </div>
      <div class="panel-content" id="vehicle-list-content">
        <div id="vehicle-list-wrapper">
          <table class="param-table" id="vehicle-list">
            <thead>
              <tr><th>è½¦è¾†ID</th><th>çŠ¶æ€</th><th>è¿è¾“æ¬¡æ•°</th><th>ä½ç½®</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      
      <div class="panel-header" id="metrics-header">
        <h3>
          <span class="collapse-icon">â–¼</span>
          ç³»ç»ŸæŒ‡æ ‡
        </h3>
      </div>
      <div class="panel-content" id="metrics-content">
        <table class="param-table">
          <tr><td>æ€»è¿è¾“æ¬¡æ•°</td><td id="total-transport-count">-</td></tr>
          <tr><td>æ€»è¿è¾“é‡é‡</td><td id="total-weight-summary">-</td></tr>
          <tr><td>æ€»ç©ºé©¶é‡Œç¨‹</td><td id="total-empty-mileage">-</td></tr>
          <tr><td>å¹³å‡åˆ©ç”¨ç‡</td><td id="avg-utilization">-</td></tr>
        </table>
      </div>
    </div>
  </div>
  
  <button class="collapse-btn" id="panel-collapse-btn" title="æ”¶èµ·/å±•å¼€é¢æ¿">â—€</button>
</div>

<div id="vehicle-modal">
  <h3 id="modal-title">è½¦è¾†è¯¦æƒ…</h3>
  <div id="modal-body"></div>
  <div style="text-align: right; margin-top: 15px;">
    <button onclick="document.getElementById('vehicle-modal').style.display='none'"
            style="padding: 6px 12px; background: #3498db; color: white; border: none; border-radius: 4px;">
      å…³é—­
    </button>
  </div>
</div>

<script type="text/javascript">
  window._AMapSecurityConfig = {
    securityJsCode:"9858defc87670662758db011c95df7ac"
  };
</script>
<script type="module" src="./map/main.js"></script>
<script type="module">
  const updateInterval = 5000;
  const DEFAULT_METRICS = {
    totalDistance: 0, waitingTime: 0, emptyDistance: 0,
    totalTime: 0, transportingTime: 0, idleRatio: 0,
    totalWeight: 0, wastedWeight: 0, utilization: 0, tripCount: 0
  };

  const chartOptions = 
  {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { position: 'top' } },
    scales: 
    {
      y: { beginAtZero: true, title: { display: true, text: 'cost' } },
      x: { title: { display: true, text: 'å‘¨æœŸ' } }
    }
  };

  let currentChartType = 'bar';
  const ctx = document.getElementById('transportChart');
  let chart = new Chart(ctx, 
  {
    type: currentChartType,
    data: 
    {
      labels: [],
      datasets: 
      [{
        label: 'è½¦è¾†æ¯å‘¨æœŸä»£ä»·å˜åŒ–',
        data: [],
        backgroundColor: 'rgba(52, 152, 219, 0.6)',
        borderColor: '#2980b9',
        borderWidth: 1,
        borderRadius: 4,
        barThickness: 20,
        tension: 0.3,
        fill: true
      }]
    },
    options: chartOptions
  });

  // æŠ˜å /å±•å¼€çŠ¶æ€
  let isPanelCollapsed = false;
  let isVehicleListCollapsed = false;
  let isMetricsCollapsed = false;

  // æ•´ä¸ªå³ä¾§é¢æ¿çš„æŠ˜å 
  document.getElementById('panel-collapse-btn').addEventListener('click', () => 
  {
    const rightPanel = document.getElementById('right-panel');
    const collapseBtn = document.getElementById('panel-collapse-btn');
    
    isPanelCollapsed = !isPanelCollapsed;
    rightPanel.classList.toggle('collapsed', isPanelCollapsed);
    collapseBtn.textContent = isPanelCollapsed ? 'â—€' : 'â–¶';
    collapseBtn.title = isPanelCollapsed ? 'å±•å¼€é¢æ¿' : 'æ”¶èµ·é¢æ¿';
    
    // å¼ºåˆ¶é‡ç»˜åœ°å›¾
    setTimeout(() => 
    {
      if (window.map) {
        window.map.resize();
      }
    }, 300);
  });

  // è½¦è¾†åˆ—è¡¨çš„æŠ˜å 
  document.getElementById('vehicle-list-header').addEventListener('click', (e) => 
  {
    const content = document.getElementById('vehicle-list-content');
    const icon = document.querySelector('#vehicle-list-header .collapse-icon');
    
    isVehicleListCollapsed = !isVehicleListCollapsed;
    content.classList.toggle('collapsed', isVehicleListCollapsed);
    icon.textContent = isVehicleListCollapsed ? 'â–¶' : 'â–¼';
    icon.style.transform = isVehicleListCollapsed ? 'rotate(-90deg)' : 'none';
  });

  // ç³»ç»ŸæŒ‡æ ‡çš„æŠ˜å 
  document.getElementById('metrics-header').addEventListener('click', (e) => 
  {
    const content = document.getElementById('metrics-content');
    const icon = document.querySelector('#metrics-header .collapse-icon');
    
    isMetricsCollapsed = !isMetricsCollapsed;
    content.classList.toggle('collapsed', isMetricsCollapsed);
    icon.textContent = isMetricsCollapsed ? 'â–¶' : 'â–¼';
    icon.style.transform = isMetricsCollapsed ? 'rotate(-90deg)' : 'none';
  });

  document.getElementById('toggle-chart-type').addEventListener('click', () => 
  {
    currentChartType = currentChartType === 'bar' ? 'line' : 'bar';
    document.getElementById('toggle-chart-type').textContent =
      currentChartType === 'bar' ? 'æŠ˜çº¿å›¾' : 'æŸ±çŠ¶å›¾';

    const labels = chart.data.labels;
    const data = chart.data.datasets[0].data;

    chart.destroy();
    chart = new Chart(ctx, 
    {
      type: currentChartType,
      data: 
      {
        labels: labels,
        datasets: 
        [{
          label: 'è½¦è¾†æ¯å‘¨æœŸcostå˜åŒ–',
          data: data,
          backgroundColor: 'rgba(52, 152, 219, 0.6)',
          borderColor: '#2980b9',
          borderWidth: 1,
          borderRadius: 4,
          barThickness: 20,
          tension: 0.3,
          fill: true
        }]
      },
      options: chartOptions
    });
  });

  let vehicles = [];

  async function fetchDashboardData() 
  {
    try 
    {
      let url = new URL('/data/getDashboardData', window.location.origin);
      const res = await fetch(url);
      const { costHistory, carMetrics, labels } = await res.json();

      if (Array.isArray(costHistory) && Array.isArray(labels)) 
      {
        chart.data.labels = labels;
        chart.data.datasets[0].data = costHistory;
        chart.update();
      }

      vehicles = carMetrics.map(c => 
      ({
        UUID: c.UUID,
        status: c.status ?? (Math.random() > 0.5 ? 1 : 0),
        lat: c.lat ?? (30.6 + Math.random() * 0.1),
        lon: c.lon ?? (104.0 + Math.random() * 0.1),
        metrics: { ...DEFAULT_METRICS, ...c }
      }));

      updateVehicleList(vehicles);
      updateSystemMetrics(vehicles);

    } 
    catch (err) 
    {
      console.error('è·å–ä»ªè¡¨ç›˜æ•°æ®å¤±è´¥:', err);
    }
  }

  function updateVehicleList(vehicleList) 
  {
    const tbody = document.querySelector('#vehicle-list tbody');
    tbody.innerHTML = vehicleList.map(v => `
      <tr class="vehicle-list" data-uuid="${v.UUID}">
        <td>${v.UUID}</td>
        <td>
        ${v.status === "TRANSPORTING" ? 'è¿è´§è¡Œé©¶' : (v.status==="AVAILABLE"?'ç©ºé—²':(v.status==="UNLOADING"?'å¸è´§':
        (v.status==="FREEZE"?'åœè½¦ç­‰å¾…':(v.status==="LOADING"?'è£…è´§':'æ¥å•è¡Œé©¶'))))}
        </td>
        <td>${v.metrics.tripCount}</td>
        <td>${v.lat.toFixed(5)}, ${v.lon.toFixed(5)}</td>
      </tr>
    `).join('');

    document.querySelectorAll('.vehicle-list').forEach(row => 
    {
      row.addEventListener('click', () => 
      {
        const uuid = row.dataset.uuid;
        const v = vehicles.find(v => v.UUID === uuid);
        if (!v) return;

        const m = v.metrics;
        console.log("ç©ºé©¶é‡Œç¨‹"+m.emptyDistance+"ç©ºé—²æ¯”"+m.idleRatio);
        const html = `
          <p><strong>UUID:</strong>${v.UUID}</p>
          <p><strong>è¿è¾“æ¬¡æ•°ï¼š</strong>${m.tripCount}</p>
          <p><strong>æ€»é‡é‡ï¼š</strong>${m.totalWeight.toFixed(1)} KG</p>
          <p><strong>ç©ºé©¶é‡Œç¨‹ï¼š</strong>${m.emptyDistance.toFixed(2)} km</p>
          <p><strong>è¿è¾“æ—¶é—´ï¼š</strong>${m.transportingTime} ms</p>
          <p><strong>æ€»æ—¶é—´ï¼š</strong>${m.totalTime} ms</p>
          <p><strong>åˆ©ç”¨ç‡ï¼š</strong>${m.utilization.toFixed(1)}%</p>
          <p><strong>ç©ºé—²æ¯”ï¼š</strong>${m.idleRatio.toFixed(2)}%</p>
          <p><strong>æµªè´¹è½½é‡ï¼š</strong>${m.wastedWeight.toFixed(1)} KG</p>
        `;

        document.getElementById('modal-title').textContent = `è½¦è¾† ${v.UUID} æŒ‡æ ‡`;
        document.getElementById('modal-body').innerHTML = html;
        document.getElementById('vehicle-modal').style.display = 'block';
      });
    });
  }

  function updateSystemMetrics(vehicleList) 
  {
    const total = vehicleList.reduce((acc, v) => 
    {
      const m = v.metrics;
      acc.trip += m.tripCount;
      acc.weight += m.totalWeight;
      acc.empty += m.emptyDistance;
      acc.util += m.utilization;
      acc.count += 0?m.utilization===0:1;
      return acc;
    }, { trip: 0, weight: 0, empty: 0, util: 0, count: 0 });
    document.getElementById('total-transport-count').textContent = total.trip;
    document.getElementById('total-weight-summary').textContent = `${total.weight.toFixed(1)} KG`;
    document.getElementById('total-empty-mileage').textContent = `${total.empty.toFixed(2)} km`;
    document.getElementById('avg-utilization').textContent = `${(total.util / total.count || 0).toFixed(1)}%`;
  }

  fetchDashboardData();
  setInterval(fetchDashboardData, updateInterval);

  // æ‰“å¼€å¯¹æ¯”å›¾æŒ‰é’®
  document.getElementById('open-comparison').addEventListener('click', () => 
  {
    window.open('comparison.html', '_blank');
  });

  // æ‰“å¼€ç³»ç»Ÿé…ç½®æŒ‰é’®
  // document.getElementById('open-config').addEventListener('click', () => 
  // {
  //   window.open('config.html', '_blank');
  // });
</script>
</body>
</html>














