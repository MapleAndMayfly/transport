<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>åœ°å›¾</title>
  <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    /* åŸæœ‰çš„CSSæ ·å¼ä¿æŒä¸å˜ */
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; overflow: hidden; }
    
    .dashboard-container {
      display: flex; 
      height: 100%; 
      position: relative;
    }
    
    #container {
      flex: 1; 
      height: 100%;
      transition: all 0.3s ease;
    }
    
    .right-panel {
      width: 400px;
      background: #f5f5f5;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      box-shadow: -2px 0 5px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    /* æ”¶èµ·çŠ¶æ€ */
    .right-panel.collapsed {
      width: 0;
      padding: 0;
      min-width: 0;
    }
    
    .right-panel.collapsed .panel-content {
      display: none;
    }
    
    .chart-container {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      height: 300px;
      overflow: hidden;
    }
    
    canvas#transportChart {
      width: 100% !important;
      height: 100% !important;
      display: block;
    }
    
    .params-container {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow-y: auto;
      flex: 1;
    }
    
    .param-table { 
      width: 100%; 
      border-collapse: collapse; 
    }
    
    .param-table td {
      padding: 6px; 
      border-bottom: 1px solid #eee;
    }
    
    .param-table td:first-child { 
      font-weight: bold; 
      color: #666; 
    }
    
    .param-table td:last-child { 
      text-align: right; 
      color: #2c3e50; 
    }
    
    .vehicle-list { 
      cursor: pointer; 
      transition: background 0.2s; 
    }
    
    .vehicle-list:hover { 
      background-color: #eef; 
    }
    
    #toggle-chart-type {
      padding: 6px 12px;
      font-size: 13px;
      border: none;
      background-color: #3498db;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    
    #vehicle-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      padding: 20px;
      min-width: 300px;
      max-width: 400px;
    }
    
    #vehicle-list-wrapper {
      height: 200px;
      overflow-y: auto;
      margin-bottom: 15px;
    }

    /* æŠ˜å æŒ‰é’® */
    .collapse-btn {
      position: absolute;
      right: 400px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 60px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 8px 0 0 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      transition: all 0.3s ease;
      z-index: 100;
      box-shadow: -2px 0 5px rgba(0,0,0,0.2);
    }
    
    .collapse-btn:hover {
      background: #2980b9;
      width: 25px;
    }
    
    /* æ”¶èµ·çŠ¶æ€ä¸‹çš„æŒ‰é’®ä½ç½® */
    .right-panel.collapsed ~ .collapse-btn {
      right: 0;
      border-radius: 0 8px 8px 0;
    }
    
    /* é¢æ¿å†…éƒ¨æŠ˜å åŠŸèƒ½ */
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      cursor: pointer;
      user-select: none;
      padding: 5px 0;
    }
    
    .panel-header h3 {
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    
    .collapse-icon {
      transition: transform 0.3s ease;
      font-size: 12px;
      color: #666;
      width: 12px;
      text-align: center;
    }
    
    .panel-content {
      transition: all 0.3s ease;
    }
    
    .panel-content.collapsed {
      display: none;
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    /* åº•éƒ¨æŒ‰é’®å®¹å™¨ */
    .bottom-buttons {
      position: fixed;
      left: 20px;
      bottom: 20px;
      z-index: 999;
      display: flex;
      gap: 10px;
    }

    .bottom-btn {
      padding: 10px 16px;
      color: white;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: background 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .comparison-btn {
      background-color: #27ae60;
    }

    .comparison-btn:hover {
      background-color: #219653;
    }

    .config-btn {
      background-color: #e67e22;
    }

    .config-btn:hover {
      background-color: #d35400;
    }
  </style>
</head>
<body>
<div class="dashboard-container">
  <!-- åº•éƒ¨æŒ‰é’®å®¹å™¨ -->
  <div class="bottom-buttons">
    <button id="open-comparison" class="bottom-btn comparison-btn">
      ğŸ“Š æ‰“å¼€å¯¹æ¯”å›¾
    </button>
    <!-- <button id="open-config" class="bottom-btn config-btn">
      âš™ï¸ ç³»ç»Ÿé…ç½®
    </button> -->
  </div>

  <div id="container"></div>
  
  <div class="right-panel" id="right-panel">
    <div class="chart-container">
      <div class="chart-header">
        <h3>æ€»ä»£ä»·å˜åŒ–</h3>
        <button id="toggle-chart-type">åˆ‡æ¢ä¸ºæŠ˜çº¿å›¾</button>
      </div>
      <canvas id="transportChart"></canvas>
    </div>
    
    <div class="params-container">
      <div class="panel-header" id="vehicle-list-header">
        <h3>
          <span class="collapse-icon">â–¼</span>
          è½¦è¾†åˆ—è¡¨
        </h3>
      </div>
      <div class="panel-content" id="vehicle-list-content">
        <div id="vehicle-list-wrapper">
          <table class="param-table" id="vehicle-list">
            <thead>
              <tr><th>è½¦è¾†ç±»å‹</th><th>çŠ¶æ€</th><th>è¿è¾“æ¬¡æ•°</th><th>ä½ç½®</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      
      <div class="panel-header" id="metrics-header">
        <h3>
          <span class="collapse-icon">â–¼</span>
          ç³»ç»ŸæŒ‡æ ‡
        </h3>
      </div>
      <div class="panel-content" id="metrics-content">
        <table class="param-table">
          <tr><td>æ€»è¿è¾“æ¬¡æ•°</td><td id="total-transport-count">-</td></tr>
          <tr><td>æ€»è¿è¾“é‡é‡</td><td id="total-weight-summary">-</td></tr>
          <tr><td>æ€»ç©ºé©¶é‡Œç¨‹</td><td id="total-empty-mileage">-</td></tr>
          <tr><td>å¹³å‡åˆ©ç”¨ç‡</td><td id="avg-utilization">-</td></tr>
        </table>
      </div>
    </div>
  </div>
  
  <button class="collapse-btn" id="panel-collapse-btn" title="æ”¶èµ·/å±•å¼€é¢æ¿">â—€</button>
</div>

<div id="vehicle-modal">
  <h3 id="modal-title">è½¦è¾†è¯¦æƒ…</h3>
  <div id="modal-body"></div>
  <div style="text-align: right; margin-top: 15px;">
    <button onclick="document.getElementById('vehicle-modal').style.display='none'"
            style="padding: 6px 12px; background: #3498db; color: white; border: none; border-radius: 4px;">
      å…³é—­
    </button>
  </div>
</div>

<script type="text/javascript">
  window._AMapSecurityConfig = {
    securityJsCode:"9858defc87670662758db011c95df7ac"
  };
</script>
<script type="module" src="./map/main.js"></script>
<script type="module">
  const updateInterval = 5000;
  // æ ¹æ®CarStatistics.javaä¿®æ­£æŒ‡æ ‡åç§°
  const DEFAULT_METRICS = {
    completeCount: 0,        // ç´¯è®¡å®Œæˆè®¢å•æ•°
    totalDistance: 0.0,      // ç´¯è®¡è¡Œé©¶è·ç¦»
    emptyDistance: 0.0,      // ç©ºé©¶é‡Œç¨‹
    busyTime: 0,             // ç´¯è®¡å·¥ä½œæ—¶é—´
    idleTime: 0,             // ç´¯è®¡ç©ºé—²æ—¶é—´
    totalWeight: 0,          // ç´¯è®¡è´§è¿è´¨é‡
    accWastedLoad: 0,        // ç´¯è®¡æµªè´¹è½½é‡
    cost: 0.0,               // å½“å‰è´§è¿æˆæœ¬
    totalCost: 0.0,          // ç´¯è®¡è´§è¿æˆæœ¬
    idleRate: 0.0,           // ç©ºé—²æ¯”ï¼ˆè®¡ç®—å­—æ®µï¼‰
    utilization: 0.0         // è´§è¿èµ„æºåˆ©ç”¨ç‡ï¼ˆè®¡ç®—å­—æ®µï¼‰
  };

  // å­˜å‚¨å†å²æ•°æ®ç”¨äºå›¾è¡¨
  let costHistory = [];
  let periodLabels = [];
  let currentPeriod = 1;

  const chartOptions = 
  {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { position: 'top' } },
    scales: 
    {
      y: { beginAtZero: true, title: { display: true, text: 'cost' } },
      x: { title: { display: true, text: 'å‘¨æœŸ' } }
    }
  };

  let currentChartType = 'bar';
  const ctx = document.getElementById('transportChart');
  let chart = new Chart(ctx, 
  {
    type: currentChartType,
    data: 
    {
      labels: [],
      datasets: 
      [{
        label: 'ç³»ç»Ÿæ€»ä»£ä»·å˜åŒ–',
        data: [],
        backgroundColor: 'rgba(52, 152, 219, 0.6)',
        borderColor: '#2980b9',
        borderWidth: 1,
        borderRadius: 4,
        barThickness: 20,
        tension: 0.3,
        fill: true
      }]
    },
    options: chartOptions
  });

  // æŠ˜å /å±•å¼€çŠ¶æ€
  let isPanelCollapsed = false;
  let isVehicleListCollapsed = false;
  let isMetricsCollapsed = false;

  // æ•´ä¸ªå³ä¾§é¢æ¿çš„æŠ˜å 
  document.getElementById('panel-collapse-btn').addEventListener('click', () => 
  {
    const rightPanel = document.getElementById('right-panel');
    const collapseBtn = document.getElementById('panel-collapse-btn');
    
    isPanelCollapsed = !isPanelCollapsed;
    rightPanel.classList.toggle('collapsed', isPanelCollapsed);
    collapseBtn.textContent = isPanelCollapsed ? 'â—€' : 'â–¶';
    collapseBtn.title = isPanelCollapsed ? 'å±•å¼€é¢æ¿' : 'æ”¶èµ·é¢æ¿';
    
    // å¼ºåˆ¶é‡ç»˜åœ°å›¾
    setTimeout(() => 
    {
      if (window.map) {
        window.map.resize();
      }
    }, 300);
  });

  // è½¦è¾†åˆ—è¡¨çš„æŠ˜å 
  document.getElementById('vehicle-list-header').addEventListener('click', (e) => 
  {
    const content = document.getElementById('vehicle-list-content');
    const icon = document.querySelector('#vehicle-list-header .collapse-icon');
    
    isVehicleListCollapsed = !isVehicleListCollapsed;
    content.classList.toggle('collapsed', isVehicleListCollapsed);
    icon.textContent = isVehicleListCollapsed ? 'â–¶' : 'â–¼';
    icon.style.transform = isVehicleListCollapsed ? 'rotate(-90deg)' : 'none';
  });

  // ç³»ç»ŸæŒ‡æ ‡çš„æŠ˜å 
  document.getElementById('metrics-header').addEventListener('click', (e) => 
  {
    const content = document.getElementById('metrics-content');
    const icon = document.querySelector('#metrics-header .collapse-icon');
    
    isMetricsCollapsed = !isMetricsCollapsed;
    content.classList.toggle('collapsed', isMetricsCollapsed);
    icon.textContent = isMetricsCollapsed ? 'â–¶' : 'â–¼';
    icon.style.transform = isMetricsCollapsed ? 'rotate(-90deg)' : 'none';
  });

  document.getElementById('toggle-chart-type').addEventListener('click', () => 
  {
    currentChartType = currentChartType === 'bar' ? 'line' : 'bar';
    document.getElementById('toggle-chart-type').textContent =
      currentChartType === 'bar' ? 'åˆ‡æ¢ä¸ºæŠ˜çº¿å›¾' : 'åˆ‡æ¢ä¸ºæŸ±çŠ¶å›¾';

    const labels = chart.data.labels;
    const data = chart.data.datasets[0].data;

    chart.destroy();
    chart = new Chart(ctx, 
    {
      type: currentChartType,
      data: 
      {
        labels: labels,
        datasets: 
        [{
          label: 'ç³»ç»Ÿæ€»costå˜åŒ–',
          data: data,
          backgroundColor: 'rgba(52, 152, 219, 0.6)',
          borderColor: '#2980b9',
          borderWidth: 1,
          borderRadius: 4,
          barThickness: 20,
          tension: 0.3,
          fill: true
        }]
      },
      options: chartOptions
    });
  });

  let vehicles = [];

  async function fetchDashboardData() 
  {
    try 
    {
      let url = new URL('/data/getDashboardData', window.location.origin);
      const res = await fetch(url);
      const responseData = await res.json();
      
      // è§£æåç«¯è¿”å›çš„æ•°æ®ç»“æ„
      // åç«¯è¿”å›çš„æ˜¯ Map<Double, List<Map<String, String>>>
      // å…¶ä¸­Keyæ˜¯æ€»costï¼ŒValueæ˜¯è½¦è¾†æ•°æ®åˆ—è¡¨
      let totalCost = 0;
      let carMetrics = [];
      
      // è§£ææ•°æ®ç»“æ„
      for (const [cycleCost, data] of Object.entries(responseData)) {
        totalCost = parseFloat(cycleCost);
        carMetrics = data;
      }

      // æ›´æ–°å›¾è¡¨æ•°æ®
      costHistory.push(totalCost);
      periodLabels.push(`å‘¨æœŸ${currentPeriod}`);
      currentPeriod++;

      // é™åˆ¶æ˜¾ç¤ºçš„æ•°æ®ç‚¹æ•°é‡
      const maxDataPoints = 20;
      if (costHistory.length > maxDataPoints) {
        costHistory = costHistory.slice(-maxDataPoints);
        periodLabels = periodLabels.slice(-maxDataPoints);
      }

      // æ›´æ–°å›¾è¡¨
      chart.data.labels = periodLabels;
      chart.data.datasets[0].data = costHistory;
      chart.update();

      // å¤„ç†è½¦è¾†æ•°æ® - æ ¹æ®CarStatistics.javaä¿®æ­£å­—æ®µå
      vehicles = carMetrics.map(c => 
      {
        const completeCount = parseInt(c.completeCount) || 0;
        const totalDistance = parseFloat(c.totalDistance) || 0;
        const emptyDistance = parseFloat(c.emptyDistance) || 0;
        const busyTime = parseInt(c.busyTime) || 0;
        const idleTime = parseInt(c.idleTime) || 0;
        
        // è®¡ç®—æ´¾ç”ŸæŒ‡æ ‡
        const idleRate = (busyTime + idleTime) > 0 ? (idleTime / (busyTime + idleTime)) * 100 : 0;
        const utilization = totalDistance > 0 ? ((totalDistance - emptyDistance) / totalDistance) * 100 : 0;

        return {
          UUID: c.UUID,
          status: c.status || (Math.random() > 0.5 ? "TRANSPORTING" : "AVAILABLE"),
          lat: parseFloat(c.lat) || (30.6 + Math.random() * 0.1),
          lon: parseFloat(c.lon) || (104.0 + Math.random() * 0.1),
          metrics: { 
            ...DEFAULT_METRICS,
            completeCount: completeCount,
            totalDistance: totalDistance,
            emptyDistance: emptyDistance,
            busyTime: busyTime,
            idleTime: idleTime,
            totalWeight: parseInt(c.totalWeight) || 0,
            accWastedLoad: parseInt(c.accWastedLoad) || 0,
            cost: parseFloat(c.cost) || 0,
            totalCost: parseFloat(c.totalCost) || 0,
            idleRate: idleRate,           // è®¡ç®—å­—æ®µ
            utilization: utilization      // è®¡ç®—å­—æ®µ
          }
        };
      });

      updateVehicleList(vehicles);
      updateSystemMetrics(vehicles);

    } 
    catch (err) 
    {
      console.error('è·å–ä»ªè¡¨ç›˜æ•°æ®å¤±è´¥:', err);
    }
  }

  function updateVehicleList(vehicleList) 
  {
    const tbody = document.querySelector('#vehicle-list tbody');
    tbody.innerHTML = vehicleList.map(v => `
      <tr class="vehicle-list" data-uuid="${v.UUID}">
        <td>è´§è½¦</td>
        <td>
        ${v.status === "TRANSPORTING" ? 'è¿è´§è¡Œé©¶' : (v.status==="AVAILABLE"?'ç©ºé—²':(v.status==="UNLOADING"?'å¸è´§':
        (v.status==="FREEZE"?'åœè½¦ç­‰å¾…':(v.status==="LOADING"?'è£…è´§':'æ¥å•è¡Œé©¶'))))}
        </td>
        <td>${v.metrics.completeCount}</td>
        <td>${v.lat.toFixed(5)}, ${v.lon.toFixed(5)}</td>
      </tr>
    `).join('');

    document.querySelectorAll('.vehicle-list').forEach(row => 
    {
      row.addEventListener('click', () => 
      {
        const uuid = row.dataset.uuid;
        const v = vehicles.find(v => v.UUID === uuid);
        if (!v) return;

        const m = v.metrics;
        const totalTime = m.busyTime + m.idleTime; // æ€»æ—¶é—´ = å·¥ä½œæ—¶é—´ + ç©ºé—²æ—¶é—´
        
        const html = `
          <p><strong>UUID:</strong> ${v.UUID}</p>
          <p><strong>è¿è¾“æ¬¡æ•°ï¼š</strong> ${m.completeCount}</p>
          <p><strong>æ€»é‡é‡ï¼š</strong> ${m.totalWeight} KG</p>
          <p><strong>ç©ºé©¶é‡Œç¨‹ï¼š</strong> ${m.emptyDistance.toFixed(2)} km</p>
          <p><strong>æ€»è¡Œé©¶é‡Œç¨‹ï¼š</strong> ${m.totalDistance.toFixed(2)} km</p>
          <p><strong>å·¥ä½œæ—¶é—´ï¼š</strong> ${m.busyTime} åˆ†é’Ÿ</p>
          <p><strong>ç©ºé—²æ—¶é—´ï¼š</strong> ${m.idleTime} åˆ†é’Ÿ</p>
          <p><strong>æ€»æ—¶é—´ï¼š</strong> ${totalTime} åˆ†é’Ÿ</p>
          <p><strong>åˆ©ç”¨ç‡ï¼š</strong> ${m.utilization.toFixed(1)}%</p>
          <p><strong>ç©ºé—²æ¯”ï¼š</strong> ${m.idleRate.toFixed(2)}%</p>
          <p><strong>æµªè´¹è½½é‡ï¼š</strong> ${m.accWastedLoad} KG</p>
          <p><strong>å½“å‰æˆæœ¬ï¼š</strong> ${m.cost.toFixed(2)}</p>
          <p><strong>ç´¯è®¡æˆæœ¬ï¼š</strong> ${m.totalCost.toFixed(2)}</p>
        `;

        document.getElementById('modal-title').textContent = `è½¦è¾† ${v.UUID} æŒ‡æ ‡`;
        document.getElementById('modal-body').innerHTML = html;
        document.getElementById('vehicle-modal').style.display = 'block';
      });
    });
  }

  function updateSystemMetrics(vehicleList) 
  {
    const total = vehicleList.reduce((acc, v) => 
    {
      const m = v.metrics;
      acc.trip += m.completeCount;
      acc.weight += m.totalWeight;
      acc.empty += m.emptyDistance;
      acc.util += m.utilization;
      acc.count += m.utilization > 0 ? 1 : 0; // åªè®¡ç®—æœ‰åˆ©ç”¨ç‡çš„è½¦è¾†
      return acc;
    }, { trip: 0, weight: 0, empty: 0, util: 0, count: 0 });
    
    document.getElementById('total-transport-count').textContent = total.trip;
    document.getElementById('total-weight-summary').textContent = `${total.weight} KG`;
    document.getElementById('total-empty-mileage').textContent = `${total.empty.toFixed(2)} km`;
    document.getElementById('avg-utilization').textContent = `${(total.count > 0 ? total.util / total.count : 0).toFixed(1)}%`;
  }

  // åˆå§‹åŒ–æ•°æ®è·å–
  fetchDashboardData();
  setInterval(fetchDashboardData, updateInterval);

  // æ‰“å¼€å¯¹æ¯”å›¾æŒ‰é’®
  document.getElementById('open-comparison').addEventListener('click', () => 
  {
    window.open('comparison.html', '_blank');
  });

  // æ‰“å¼€ç³»ç»Ÿé…ç½®æŒ‰é’®
  // document.getElementById('open-config').addEventListener('click', () => 
  // {
  //   window.open('config.html', '_blank');
  // });
</script>
</body>
</html>
