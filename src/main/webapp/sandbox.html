<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®æ²™ç®±ä»¿çœŸæµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        
        header h1 {
            font-size: 32px;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        header p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .content {
            display: grid;
            grid-template-columns: 300px 1fr;
            min-height: 700px;
        }
        
        .control-panel {
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            padding: 25px 20px;
        }
        
        .dashboard-panel {
            flex: 1;
            padding: 25px 30px;
            background: #fafbfc;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .panel-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        .control-group {
            margin-bottom: 25px;
        }
        
        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .form-control:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #219653;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }
        
        .status-indicator {
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .status-real {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-simulated {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 300px;
        }
        
        .stats-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            border-left: 4px solid #3498db;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .vehicle-list {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 400px;
            overflow-y: auto;
        }
        
        .vehicle-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .vehicle-table th {
            background: #3498db;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        .vehicle-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .vehicle-table tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .status-transporting {
            background: #d4edda;
            color: #155724;
        }
        
        .status-available {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-loading {
            background: #fff3cd;
            color: #856404;
        }
        
        .scenario-presets {
            margin-top: 20px;
        }
        
        .preset-item {
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .preset-item:hover {
            border-color: #3498db;
            background: #e3f2fd;
        }
        
        .preset-item.active {
            border-color: #3498db;
            background: #3498db;
            color: white;
        }
        
        .preset-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .preset-desc {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .simulation-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .info-label {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .info-value {
            color: #3498db;
            font-weight: 600;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .chart-actions {
            display: flex;
            gap: 10px;
        }
        
        .chart-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .chart-btn:hover {
            background: #f8f9fa;
        }
        
        .chart-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        @media (max-width: 1024px) {
            .content {
                grid-template-columns: 1fr;
            }
            
            .control-panel {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .vehicle-table {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ§ª æ•°æ®æ²™ç®± - ä»¿çœŸæµ‹è¯•å¹³å°</h1>
            <p>å®æ—¶æ•°æ®æ¨¡æ‹Ÿã€åœºæ™¯æµ‹è¯•ä¸æ€§èƒ½åˆ†æ</p>
        </header>
        
        <div class="content">
            <div class="control-panel">
                <div class="panel-title">æ²™ç®±æ§åˆ¶</div>
                
                <div class="control-group">
                    <div id="mode-status" class="status-indicator status-real">
                        â— å½“å‰æ¨¡å¼: çœŸå®æ•°æ®
                    </div>
                    
                    <button class="btn btn-warning" id="toggle-mode-btn">
                        <i>ğŸ”„</i> åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼
                    </button>
                </div>
                
                <div class="control-group">
                    <label>æ•°æ®è¶‹åŠ¿æ¨¡å¼:</label>
                    <select class="form-control" id="data-trend">
                        <option value="stable">ç¨³å®šæ³¢åŠ¨</option>
                        <option value="increasing">é€æ­¥ä¸Šå‡</option>
                        <option value="decreasing">é€æ­¥ä¸‹é™</option>
                        <option value="volatile">å‰§çƒˆæ³¢åŠ¨</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>æ¨¡æ‹Ÿè½¦è¾†æ•°é‡:</label>
                    <input type="number" class="form-control" id="vehicle-count" value="8" min="1" max="50">
                </div>
                
                <div class="control-group">
                    <label>åŸºç¡€æˆæœ¬èŒƒå›´:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" class="form-control" id="cost-min" value="800" placeholder="æœ€å°å€¼">
                        <input type="number" class="form-control" id="cost-max" value="1200" placeholder="æœ€å¤§å€¼">
                    </div>
                </div>
                
                <div class="control-group">
                    <label>æ•°æ®æ›´æ–°é¢‘ç‡:</label>
                    <select class="form-control" id="update-frequency">
                        <option value="1000">1ç§’</option>
                        <option value="2000" selected>2ç§’</option>
                        <option value="5000">5ç§’</option>
                        <option value="10000">10ç§’</option>
                    </select>
                </div>
                
                <button class="btn btn-success" id="apply-config-btn">
                    <i></i> åº”ç”¨é…ç½®
                </button>
                
                <button class="btn btn-primary" id="reset-data-btn">
                    <i></i> é‡ç½®æ¨¡æ‹Ÿæ•°æ®
                </button>
                
                <button class="btn btn-danger" id="export-data-btn">
                    <i></i> å¯¼å‡ºæµ‹è¯•æ•°æ®
                </button>

                <div class="scenario-presets">
                    <div class="panel-title">æµ‹è¯•åœºæ™¯</div>
                    
                    <div class="preset-item active" data-scenario="normal">
                        <div class="preset-name">æ­£å¸¸è¿è¥</div>
                        <div class="preset-desc">å¹³ç¨³çš„ä¸šåŠ¡åœºæ™¯</div>
                    </div>
                    
                    <div class="preset-item" data-scenario="peak">
                        <div class="preset-name">é«˜å³°æ—¶æ®µ</div>
                        <div class="preset-desc">é«˜è´Ÿè½½å‹åŠ›æµ‹è¯•</div>
                    </div>
                    
                    <div class="preset-item" data-scenario="failure">
                        <div class="preset-name">æ•…éšœæ¨¡æ‹Ÿ</div>
                        <div class="preset-desc">éƒ¨åˆ†è½¦è¾†æ•…éšœåœºæ™¯</div>
                    </div>
                    
                    <div class="preset-item" data-scenario="optimized">
                        <div class="preset-name">ä¼˜åŒ–é…ç½®</div>
                        <div class="preset-desc">æœ€ä½³å‚æ•°é…ç½®æµ‹è¯•</div>
                    </div>
                </div>
                
                <div class="simulation-info">
                    <div class="info-item">
                        <span class="info-label">è¿è¡Œå‘¨æœŸ:</span>
                        <span class="info-value" id="current-period">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">æ¨¡æ‹Ÿæ—¶é•¿:</span>
                        <span class="info-value" id="simulation-time">00:00</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">æ•°æ®ç‚¹æ•°:</span>
                        <span class="info-value" id="data-points">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">çŠ¶æ€:</span>
                        <span class="info-value" id="simulation-status">å°±ç»ª</span>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-panel">
                <div class="dashboard-grid">
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">ç³»ç»Ÿæ€»æˆæœ¬è¶‹åŠ¿</div>
                            <div class="chart-actions">
                                <button class="chart-btn active" data-type="line">æŠ˜çº¿å›¾</button>
                                <button class="chart-btn" data-type="bar">æŸ±çŠ¶å›¾</button>
                                <button class="chart-btn" data-type="clear">æ¸…é™¤æ•°æ®</button>
                            </div>
                        </div>
                        <canvas id="costChart"></canvas>
                    </div>
                    
                    <div class="stats-container">
                        <div class="chart-title">ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡</div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">æ€»è¿è¾“æ¬¡æ•°</div>
                                <div class="stat-value" id="total-trips">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å¹³å‡åˆ©ç”¨ç‡</div>
                                <div class="stat-value" id="avg-utilization">0%</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æ€»ç©ºé©¶é‡Œç¨‹</div>
                                <div class="stat-value" id="total-empty">0km</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">ç³»ç»Ÿæ€»æˆæœ¬</div>
                                <div class="stat-value" id="total-cost">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="vehicle-list">
                    <div class="chart-title">è½¦è¾†å®æ—¶çŠ¶æ€</div>
                    <table class="vehicle-table">
                        <thead>
                            <tr>
                                <th>è½¦è¾†ID</th>
                                <th>çŠ¶æ€</th>
                                <th>è¿è¾“æ¬¡æ•°</th>
                                <th>å½“å‰ä½ç½®</th>
                                <th>åˆ©ç”¨ç‡</th>
                                <th>ç©ºé©¶é‡Œç¨‹</th>
                            </tr>
                        </thead>
                        <tbody id="vehicle-table-body">
                            <!-- è½¦è¾†æ•°æ®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ•°æ®æ²™ç®±ç®¡ç†å™¨
        const sandboxManager = {
            // æ²™ç®±çŠ¶æ€
            isSimulationMode: false,
            simulationConfig: {
                dataTrend: 'stable',
                vehicleCount: 8,
                costRange: { min: 800, max: 1200 },
                updateFrequency: 2000
            },
            simulationData: {
                costHistory: [],
                periodLabels: [],
                vehicles: [],
                startTime: null,
                currentPeriod: 0
            },
            
            // Chart.js å®ä¾‹
            costChart: null,
            chartType: 'line',
            
            // å®šæ—¶å™¨
            dataUpdateInterval: null,
            
            // åˆå§‹åŒ–æ²™ç®±
            async init() {
                console.log("åˆå§‹åŒ–æ•°æ®æ²™ç®±");
                
                // åˆå§‹åŒ–å›¾è¡¨
                this.initCostChart();
                
                // åŠ è½½å½“å‰çŠ¶æ€
                await this.loadSimulationStatus();
                
                // ç»‘å®šäº‹ä»¶
                this.bindEvents();
                
                // å¼€å§‹æ•°æ®æ›´æ–°
                this.startDataUpdates();
                
                this.showStatus('æ•°æ®æ²™ç®±å·²å°±ç»ª', 'success');
            },
            
            // åˆå§‹åŒ–æˆæœ¬å›¾è¡¨
            initCostChart() {
                const ctx = document.getElementById('costChart').getContext('2d');
                this.costChart = new Chart(ctx, {
                    type: this.chartType,
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'ç³»ç»Ÿæ€»æˆæœ¬',
                            data: [],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'æˆæœ¬'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'å‘¨æœŸ'
                                }
                            }
                        }
                    }
                });
            },
            
            // ç»‘å®šäº‹ä»¶å¤„ç†
            bindEvents() {
                // æ¨¡å¼åˆ‡æ¢
                document.getElementById('toggle-mode-btn').addEventListener('click', () => {
                    this.toggleSimulationMode();
                });
                
                // åº”ç”¨é…ç½®
                document.getElementById('apply-config-btn').addEventListener('click', () => {
                    this.applyConfiguration();
                });
                
                // é‡ç½®æ•°æ®
                document.getElementById('reset-data-btn').addEventListener('click', () => {
                    this.resetSimulationData();
                });
                
                // å¯¼å‡ºæ•°æ®
                document.getElementById('export-data-btn').addEventListener('click', () => {
                    this.exportTestData();
                });
                
                // å›¾è¡¨ç±»å‹åˆ‡æ¢
                document.querySelectorAll('.chart-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const type = e.target.dataset.type;
                        if (type === 'clear') {
                            this.clearChartData();
                        } else {
                            this.switchChartType(type);
                        }
                    });
                });
                
                // åœºæ™¯é¢„è®¾
                document.querySelectorAll('.preset-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const scenario = e.currentTarget.dataset.scenario;
                        this.applyScenario(scenario);
                    });
                });
            },
            
            // åˆ‡æ¢æ¨¡æ‹Ÿæ¨¡å¼
            async toggleSimulationMode() {
                try {
                    const response = await fetch('/dataSandbox/toggleSimulation');
                    const result = await response.json();
                    
                    this.isSimulationMode = result.simulationMode;
                    this.updateModeUI();
                    this.showStatus(
                        this.isSimulationMode ? 'å·²åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼' : 'å·²åˆ‡æ¢åˆ°çœŸå®æ•°æ®æ¨¡å¼', 
                        'success'
                    );
                    
                    // é‡æ–°åŠ è½½æ•°æ®
                    this.fetchData();
                    
                } catch (error) {
                    console.error('åˆ‡æ¢æ¨¡å¼å¤±è´¥:', error);
                    this.showStatus('æ¨¡å¼åˆ‡æ¢å¤±è´¥: ' + error.message, 'error');
                }
            },
            
            // åº”ç”¨é…ç½®
            applyConfiguration() {
                this.simulationConfig = {
                    dataTrend: document.getElementById('data-trend').value,
                    vehicleCount: parseInt(document.getElementById('vehicle-count').value),
                    costRange: {
                        min: parseInt(document.getElementById('cost-min').value),
                        max: parseInt(document.getElementById('cost-max').value)
                    },
                    updateFrequency: parseInt(document.getElementById('update-frequency').value)
                };
                
                // é‡å¯æ•°æ®æ›´æ–°
                this.restartDataUpdates();
                
                this.showStatus('é…ç½®å·²åº”ç”¨', 'success');
            },
            
            // åº”ç”¨æµ‹è¯•åœºæ™¯
            applyScenario(scenario) {
                // æ›´æ–°é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.preset-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-scenario="${scenario}"]`).classList.add('active');
                
                // æ ¹æ®åœºæ™¯è°ƒæ•´é…ç½®
                switch (scenario) {
                    case 'peak':
                        this.simulationConfig.dataTrend = 'increasing';
                        this.simulationConfig.vehicleCount = 15;
                        this.simulationConfig.costRange = { min: 1000, max: 2000 };
                        break;
                    case 'failure':
                        this.simulationConfig.dataTrend = 'volatile';
                        this.simulationConfig.vehicleCount = 5;
                        break;
                    case 'optimized':
                        this.simulationConfig.dataTrend = 'decreasing';
                        this.simulationConfig.costRange = { min: 500, max: 800 };
                        break;
                    case 'normal':
                    default:
                        this.simulationConfig.dataTrend = 'stable';
                        this.simulationConfig.vehicleCount = 8;
                        this.simulationConfig.costRange = { min: 800, max: 1200 };
                }
                
                // æ›´æ–°UI
                this.updateConfigUI();
                this.showStatus(`å·²åº”ç”¨ ${scenario} åœºæ™¯`, 'success');
            },
            
            // é‡ç½®æ¨¡æ‹Ÿæ•°æ®
            async resetSimulationData() {
                try {
                    const response = await fetch('/dataSandbox/resetSimulation');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.simulationData = {
                            costHistory: [],
                            periodLabels: [],
                            vehicles: [],
                            startTime: new Date(),
                            currentPeriod: 0
                        };
                        
                        this.updateCharts();
                        this.showStatus('æ¨¡æ‹Ÿæ•°æ®å·²é‡ç½®', 'success');
                    }
                } catch (error) {
                    console.error('é‡ç½®æ•°æ®å¤±è´¥:', error);
                    this.showStatus('é‡ç½®å¤±è´¥: ' + error.message, 'error');
                }
            },
            
            // å¯¼å‡ºæµ‹è¯•æ•°æ®
            exportTestData() {
                const dataStr = JSON.stringify(this.simulationData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `simulation-data-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                this.showStatus('æµ‹è¯•æ•°æ®å·²å¯¼å‡º', 'success');
            },
            
            // åˆ‡æ¢å›¾è¡¨ç±»å‹
            switchChartType(type) {
                this.chartType = type;
                this.costChart.destroy();
                this.initCostChart();
                this.updateCharts();
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.chart-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-type="${type}"]`).classList.add('active');
            },
            
            // æ¸…é™¤å›¾è¡¨æ•°æ®
            clearChartData() {
                this.simulationData.costHistory = [];
                this.simulationData.periodLabels = [];
                this.updateCharts();
                this.showStatus('å›¾è¡¨æ•°æ®å·²æ¸…é™¤', 'success');
            },
            
            // å¼€å§‹æ•°æ®æ›´æ–°
            startDataUpdates() {
                this.dataUpdateInterval = setInterval(() => {
                    this.fetchData();
                }, this.simulationConfig.updateFrequency);
            },
            
            // é‡å¯æ•°æ®æ›´æ–°
            restartDataUpdates() {
                if (this.dataUpdateInterval) {
                    clearInterval(this.dataUpdateInterval);
                }
                this.startDataUpdates();
            },
            
            // è·å–æ•°æ®
            async fetchData() {
                try {
                    let url;
                    if (this.isSimulationMode) {
                        url = new URL('/dataSandbox/getSimulationData', window.location.origin);
                    } else {
                        url = new URL('/data/getDashboardData', window.location.origin);
                    }
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    this.processData(data);
                    
                } catch (error) {
                    console.error('è·å–æ•°æ®å¤±è´¥:', error);
                }
            },
            
            // å¤„ç†æ•°æ®
            processData(data) {
                // æ›´æ–°æ¨¡æ‹Ÿæ•°æ®
                this.simulationData.currentPeriod++;
                
                // å¤„ç†æˆæœ¬æ•°æ®
                let totalCost = 0;
                if (this.isSimulationMode) {
                    // æ¨¡æ‹Ÿæ¨¡å¼æ•°æ®
                    for (const [cost, vehicleData] of Object.entries(data)) {
                        totalCost = parseFloat(cost);
                        this.simulationData.vehicles = vehicleData;
                    }
                } else {
                    // çœŸå®æ•°æ®
                    for (const [cost, vehicleData] of Object.entries(data)) {
                        totalCost = parseFloat(cost);
                        this.simulationData.vehicles = vehicleData;
                    }
                }
                
                // æ›´æ–°å†å²æ•°æ®
                this.simulationData.costHistory.push(totalCost);
                this.simulationData.periodLabels.push(`å‘¨æœŸ${this.simulationData.currentPeriod}`);
                
                // é™åˆ¶æ•°æ®ç‚¹æ•°é‡
                const maxDataPoints = 20;
                if (this.simulationData.costHistory.length > maxDataPoints) {
                    this.simulationData.costHistory.shift();
                    this.simulationData.periodLabels.shift();
                }
                
                // æ›´æ–°UI
                this.updateCharts();
                this.updateStats();
                this.updateVehicleTable();
                this.updateSimulationInfo();
            },
            
            // æ›´æ–°å›¾è¡¨
            updateCharts() {
                if (this.costChart) {
                    this.costChart.data.labels = this.simulationData.periodLabels;
                    this.costChart.data.datasets[0].data = this.simulationData.costHistory;
                    this.costChart.update('none');
                }
            },
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStats() {
                const trips = this.simulationData.vehicles.reduce((sum, v) => sum + (parseInt(v.tripCount) || 0), 0);
                const utilization = this.simulationData.vehicles.reduce((sum, v) => sum + (parseFloat(v.utilization) || 0), 0) / this.simulationData.vehicles.length;
                const emptyDistance = this.simulationData.vehicles.reduce((sum, v) => sum + (parseFloat(v.emptyDistance) || 0), 0);
                const totalCost = this.simulationData.costHistory[this.simulationData.costHistory.length - 1] || 0;
                
                document.getElementById('total-trips').textContent = trips;
                document.getElementById('avg-utilization').textContent = utilization.toFixed(1) + '%';
                document.getElementById('total-empty').textContent = emptyDistance.toFixed(1) + 'km';
                document.getElementById('total-cost').textContent = totalCost.toFixed(0);
            },
            
            // æ›´æ–°è½¦è¾†è¡¨æ ¼
            updateVehicleTable() {
                const tbody = document.getElementById('vehicle-table-body');
                tbody.innerHTML = this.simulationData.vehicles.map(vehicle => `
                    <tr>
                        <td>${vehicle.UUID}</td>
                        <td>
                            <span class="status-badge status-${vehicle.status?.toLowerCase() || 'available'}">
                                ${this.getStatusText(vehicle.status)}
                            </span>
                        </td>
                        <td>${vehicle.tripCount || 0}</td>
                        <td>${(parseFloat(vehicle.lat) || 0).toFixed(4)}, ${(parseFloat(vehicle.lon) || 0).toFixed(4)}</td>
                        <td>${(parseFloat(vehicle.utilization) || 0).toFixed(1)}%</td>
                        <td>${(parseFloat(vehicle.emptyDistance) || 0).toFixed(1)}km</td>
                    </tr>
                `).join('');
            },
            
            // è·å–çŠ¶æ€æ–‡æœ¬
            getStatusText(status) {
                const statusMap = {
                    'TRANSPORTING': 'è¿è¾“ä¸­',
                    'AVAILABLE': 'ç©ºé—²',
                    'LOADING': 'è£…è´§',
                    'UNLOADING': 'å¸è´§',
                    'ORDER_TAKEN': 'æ¥å•ä¸­'
                };
                return statusMap[status] || 'æœªçŸ¥';
            },
            
            // æ›´æ–°æ¨¡æ‹Ÿä¿¡æ¯
            updateSimulationInfo() {
                document.getElementById('current-period').textContent = this.simulationData.currentPeriod;
                document.getElementById('data-points').textContent = this.simulationData.costHistory.length;
                
                // è®¡ç®—è¿è¡Œæ—¶é—´
                if (this.simulationData.startTime) {
                    const now = new Date();
                    const diff = Math.floor((now - this.simulationData.startTime) / 1000);
                    const minutes = Math.floor(diff / 60);
                    const seconds = diff % 60;
                    document.getElementById('simulation-time').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            },
            
            // æ›´æ–°æ¨¡å¼UI
            updateModeUI() {
                const statusEl = document.getElementById('mode-status');
                const buttonEl = document.getElementById('toggle-mode-btn');
                
                if (this.isSimulationMode) {
                    statusEl.className = 'status-indicator status-simulated';
                    statusEl.innerHTML = 'â— å½“å‰æ¨¡å¼: æ¨¡æ‹Ÿæ•°æ®';
                    buttonEl.innerHTML = '<i>ğŸ”„</i> åˆ‡æ¢åˆ°çœŸå®æ•°æ®';
                } else {
                    statusEl.className = 'status-indicator status-real';
                    statusEl.innerHTML = 'â— å½“å‰æ¨¡å¼: çœŸå®æ•°æ®';
                    buttonEl.innerHTML = '<i>ğŸ”„</i> åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼';
                }
            },
            
            // æ›´æ–°é…ç½®UI
            updateConfigUI() {
                document.getElementById('data-trend').value = this.simulationConfig.dataTrend;
                document.getElementById('vehicle-count').value = this.simulationConfig.vehicleCount;
                document.getElementById('cost-min').value = this.simulationConfig.costRange.min;
                document.getElementById('cost-max').value = this.simulationConfig.costRange.max;
                document.getElementById('update-frequency').value = this.simulationConfig.updateFrequency;
            },
            
            // åŠ è½½æ¨¡æ‹ŸçŠ¶æ€
            async loadSimulationStatus() {
                try {
                    const response = await fetch('/dataSandbox/getSimulationStatus');
                    const status = await response.json();
                    
                    this.isSimulationMode = status.simulationMode;
                    this.updateModeUI();
                    
                } catch (error) {
                    console.error('åŠ è½½æ¨¡æ‹ŸçŠ¶æ€å¤±è´¥:', error);
                }
            },
            
            // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
            showStatus(message, type) {
                // è¿™é‡Œå¯ä»¥æ·»åŠ çŠ¶æ€æç¤ºæ˜¾ç¤ºé€»è¾‘
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
        };

        // åˆå§‹åŒ–æ²™ç®±
        document.addEventListener('DOMContentLoaded', () => {
            sandboxManager.init();
        });

    </script>
</body>
</html>
